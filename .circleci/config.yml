version: 2.1

orbs:
  aws-cli: circleci/aws-cli@3.1.5
  aws-s3: circleci/aws-s3@1.0.15

jobs:
  build_project:
    docker:
      - image: cimg/openjdk:17.0.2
        environment:
          TZ: "Asia/Singapore"
    working_directory: ~/ci
    environment:
      # Customize the JVM maximum heap limit
      MAVEN_OPTS: -Xmx3200m
      TZ: "Asia/Singapore"
    steps:
      - checkout:
          path: ~/ci
      # Download and cache dependencies
      - run:
          command: echo "hello this fucking world" > ~/hello.txt
      - save_cache:
          name: Save hello.txt file to cache
          key: ci-hello
          paths: ~/hello.txt
      - restore_cache:
          keys:
            - ci-hello
            # fallback to using the latest cache if no exact match is found
            - ci-
          name: Get hello file from cache
      - store_artifacts:
          path: ~/ci/deployment/
      - persist_to_workspace:
          root: ~/ci
          paths:
            - deployment
  
  deploy_uat:
    executor: aws-cli/default
    steps:
      - attach_workspace:
          at: ~/ci
      - aws-s3/sync:
          arguments: '--exclude * --include *.tar'
          from: ~/ci/deployment/
          to: ''
  deploy_prod:
    executor: aws-cli/default
    steps:
      - attach_workspace:
          at: ~/ci
      - aws-s3/sync:
          arguments: '--exclude * --include *.tar'
          from: ~/ci/deployment/
          to: ''

only-build-branches: &only-build-branches
  filters:
    branches:
      only:
        - uat
        - master
        - circleci-project-setup

workflows:
  build_and_deploy:
    jobs:
      - build_project: *only-build-branches
      - deploy_uat:
          requires:
            - build_project
          filters:
              branches:
                only:
                  - uat
      - deploy_prod:
          requires:
            - build_project
          filters:
              branches:
                only:
                  - master
